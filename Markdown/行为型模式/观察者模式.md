# è§‚å¯Ÿè€…æ¨¡å¼

**ä»£ç ç³»åˆ—ï¼štutorials21**

**è§‚å¯Ÿè€…æ¨¡å¼ï¼š**æŒ‡å¤šä¸ªå¯¹è±¡é—´å­˜åœ¨ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ï¼Œè¿™ç§æ¨¡å¼æœ‰æ—¶åˆç§°ä½œå‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€æ¨¡å‹-è§†å›¾æ¨¡å¼ï¼Œå®ƒæ˜¯å¯¹è±¡è¡Œä¸ºæ¨¡å¼

**å›¾ä¾‹ï¼š**

![è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå›¾ç‰‡æ¥è‡ª refactoringguru.cn](https://bugstack.cn/assets/images/2020/itstack-demo-design-18-01.png)

## æ¡ˆä¾‹åœºæ™¯æ¨¡æ‹Ÿ

![åœºæ™¯æ¨¡æ‹Ÿï¼›å°å®¢è½¦æŒ‡æ ‡æ‘‡å·é€šçŸ¥åœºæ™¯](https://bugstack.cn/assets/images/2020/itstack-demo-design-18-03.png)

**åœ¨æœ¬æ¡ˆä¾‹ä¸­æˆ‘ä»¬æ¨¡æ‹Ÿæ¯æ¬¡å°å®¢è½¦æŒ‡æ ‡æ‘‡å·äº‹ä»¶é€šçŸ¥åœºæ™¯(çœŸå®çš„ä¸ä¼šç”±å®˜ç½‘ç»™ä½ å‘æ¶ˆæ¯)**

å¯èƒ½å¤§éƒ¨åˆ†äººçœ‹åˆ°è¿™ä¸ªæ¡ˆä¾‹ä¸€å®šä¼šæƒ³åˆ°è‡ªå·±æ¯æ¬¡æ‘‡å·éƒ½ä¸ä¸­çš„åœºæ™¯ï¼Œæ”¶åˆ°ä¸€ä¸ªé—æ†¾çš„çŸ­ä¿¡é€šçŸ¥ã€‚å½“ç„¶ç›®å‰çš„æ‘‡å·ç³»ç»Ÿå¹¶ä¸ä¼šç»™ä½ å‘çŸ­ä¿¡ï¼Œè€Œæ˜¯ç”±ç™¾åº¦æˆ–è€…ä¸€äº›å…¶ä»–æ’ä»¶å‘çš„çŸ­ä¿¡ã€‚é‚£ä¹ˆå‡å¦‚è¿™ä¸ªç±»ä¼¼çš„æ‘‡å·åŠŸèƒ½å¦‚æœç”±ä½ æ¥å¼€å‘ï¼Œå¹¶ä¸”éœ€è¦å¯¹å¤–éƒ¨çš„ç”¨æˆ·åšä¸€äº›äº‹ä»¶é€šçŸ¥ä»¥åŠéœ€è¦åœ¨ä¸»æµç¨‹å¤–å†æ·»åŠ ä¸€äº›é¢å¤–çš„è¾…åŠ©æµç¨‹æ—¶è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

åŸºæœ¬å¾ˆå¤šäººå¯¹äºè¿™æ ·çš„é€šçŸ¥äº‹ä»¶ç±»çš„å®ç°å¾€å¾€æ¯”è¾ƒç²—çŠ·ï¼Œç›´æ¥åœ¨ç±»é‡Œé¢å°±æ·»åŠ äº†ã€‚1æ˜¯è€ƒè™‘ğŸ¤”è¿™å¯èƒ½ä¸ä¼šæ€ä¹ˆæ‰©å±•ï¼Œ2æ˜¯å‹æ ¹å°±æ²¡è€ƒè™‘ğŸ˜„è¿‡ã€‚ä½†å¦‚æœä½ æœ‰ä»”ç»†æ€è€ƒè¿‡ä½ çš„æ ¸å¿ƒç±»åŠŸèƒ½ä¼šå‘ç°ï¼Œè¿™é‡Œé¢æœ‰ä¸€äº›æ ¸å¿ƒä¸»é“¾è·¯ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯è¾…åŠ©åŠŸèƒ½ã€‚æ¯”å¦‚å®Œæˆäº†æŸä¸ªè¡Œä¸ºåéœ€è¦è§¦å‘MQç»™å¤–éƒ¨ï¼Œä»¥åŠåšä¸€äº›æ¶ˆæ¯PUSHç»™ç”¨æˆ·ç­‰ï¼Œè¿™äº›éƒ½ä¸ç®—åšæ˜¯æ ¸å¿ƒæµç¨‹é“¾è·¯ï¼Œæ˜¯å¯ä»¥é€šè¿‡äº‹ä»¶é€šçŸ¥çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨è¿™æ ·çš„è®¾è®¡æ¨¡å¼æ¥ä¼˜åŒ–é‡æ„æ­¤åœºæ™¯ä¸‹çš„ä»£ç 

```java
public class MinibusTargetService {

    /**
     * æ¨¡æ‹Ÿæ‘‡å·ï¼Œä½†ä¸æ˜¯æ‘‡å·ç®—æ³•
     * @param uId ç”¨æˆ·ç¼–å·
     * @return ç»“æœ
     */
    public String lottery(String uId){
        return Math.abs(uId.hashCode()) % 2 == 0 ? "æ­å–œä½ ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·ä¸­ç­¾") : "å¾ˆé—æ†¾ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ");
    }
}
```

éå¸¸ç®€å•çš„ä¸€ä¸ªæ¨¡æ‹Ÿæ‘‡å·æ¥å£ï¼Œä¸çœŸå®å…¬å¹³çš„æ‘‡å·æ˜¯æœ‰å·®åˆ«çš„

æŒ‰ç…§éœ€æ±‚éœ€è¦åœ¨åŸæœ‰çš„æ‘‡å·æ¥å£ä¸­æ·»åŠ MQæ¶ˆæ¯å‘é€ä»¥åŠçŸ­æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½ï¼Œå¦‚æœæ˜¯æœ€ç›´æ¥çš„æ–¹å¼é‚£ä¹ˆå¯ä»¥ç›´æ¥åœ¨æ–¹æ³•ä¸­è¡¥å……åŠŸèƒ½å³å¯

## å·¥ç¨‹ç»“æ„

```java
itstack-demo-design-18-01
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ LotteryResult.java
                â”œâ”€â”€ LotteryService.java
                â””â”€â”€ LotteryServiceImpl.java
    
```

è¿™æ®µä»£ç æ¥å£ä¸­åŒ…æ‹¬äº†ä¸‰éƒ¨åˆ†å†…å®¹ï¼šè¿”å›å¯¹è±¡(`LotteryResult`)ã€å®šä¹‰æ¥å£(`LotteryService`)ã€å…·ä½“å®ç°(`LotteryServiceImpl`)



## é‡æ„ä»£ç 

```cmd
itstack-demo-design-18-02
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ event
                â”‚    â”œâ”€â”€ listener
                â”‚    â”‚    â”œâ”€â”€ EventListener.java
                â”‚    â”‚    â”œâ”€â”€ MessageEventListener.java
                â”‚    â”‚    â””â”€â”€ MQEventListener.java
                â”‚    â””â”€â”€ EventManager.java
                â”œâ”€â”€ LotteryResult.java
                â”œâ”€â”€ LotteryService.java
                â””â”€â”€ LotteryServiceImpl.java
```

**æ¨¡å‹ç»“æ„**

![è§‚å¯Ÿè€…æ¨¡å¼æ¨¡å‹ç»“æ„](https://bugstack.cn/assets/images/2020/itstack-demo-design-18-04.png)

- ä»ä¸Šå›¾å¯ä»¥åˆ†ä¸ºä¸‰å¤§å—çœ‹ï¼š**äº‹ä»¶ç›‘å¬ã€äº‹ä»¶å¤„ç†ã€å…·ä½“çš„ä¸šåŠ¡æµç¨‹**ï¼Œå¦å¤–åœ¨ä¸šåŠ¡æµç¨‹ä¸­ `LotteryService` å®šä¹‰çš„æ˜¯æŠ½è±¡ç±»ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é€šè¿‡æŠ½è±¡ç±»å°†äº‹ä»¶åŠŸèƒ½å±è”½ï¼Œå¤–éƒ¨ä¸šåŠ¡æµç¨‹å¼€å‘è€…ä¸éœ€è¦çŸ¥é“å…·ä½“çš„é€šçŸ¥æ“ä½œã€‚
- å³ä¸‹è§’åœ†åœˆå›¾è¡¨ç¤ºçš„æ˜¯æ ¸å¿ƒæµç¨‹ä¸éæ ¸å¿ƒæµç¨‹çš„ç»“æ„ï¼Œä¸€èˆ¬åœ¨å¼€å‘ä¸­ä¼šæŠŠä¸»çº¿æµç¨‹å¼€å‘å®Œæˆåï¼Œå†ä½¿ç”¨é€šçŸ¥çš„æ–¹å¼å¤„ç†è¾…åŠ©æµç¨‹ã€‚å®ƒä»¬å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨MQä»¥åŠå®šæ—¶ä»»åŠ¡çš„å¤„ç†ä¸‹ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§

```java
public class EventManager {
    public enum EventType{
        MESSAGE,
        MQ;
    }

    // äº‹ä»¶ç›‘å¬è€…åˆ—è¡¨æ˜ å°„
    private Map<Enum<EventType>, List<EventListener>> listenerListMap = new HashMap<>();

    public EventManager(Enum<EventType>...operations) {
        for(Enum<EventType> operation : operations) {
            this.listenerListMap.put(operation,new ArrayList<>());
        }
    }

    /**
     * è®¢é˜…äº‹ä»¶ç›‘å¬
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬å®ä½“
     */
    public void subscribe(Enum<EventType> eventType, EventListener listener) {
        listenerListMap.get(eventType).add(listener);
    }

    /**
     * å–æ¶ˆäº‹ä»¶ç›‘å¬è®¢é˜…
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬å®ä½“
     */
    public void unsubscribe(Enum<EventType> eventType, EventListener listener) {
        listenerListMap.get(eventType).remove(listener);
    }

    /**
     * äº‹ä»¶é€šçŸ¥
     * @param eventType æ‰€è¦æ‰§è¡Œäº‹ä»¶ç±»å‹
     * @param result æ‰€è¦ç›‘å¬äº‹ä»¶ï¼Œæ­¤äº‹ä»¶å¯ä»¥æ›´æ”¹
     */
    public void notify(Enum<EventType> eventType, LotteryResult result) {
        List<EventListener> listenerList = listenerListMap.get(eventType);
        for(EventListener listener : listenerList) {
            listener.doEvent(result);
        }
    }
}
```

- æ•´ä¸ªå¤„ç†çš„å®ç°ä¸Šæä¾›äº†ä¸‰ä¸ªä¸»è¦æ–¹æ³•ï¼šè®¢é˜…(`subscribe`)ã€å–æ¶ˆè®¢é˜…(`unsubscribe`)ã€é€šçŸ¥(`notify`)ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºå¯¹ç›‘å¬äº‹ä»¶çš„æ·»åŠ å’Œä½¿ç”¨ã€‚
- å¦å¤–å› ä¸ºäº‹ä»¶æœ‰ä¸åŒçš„ç±»å‹ï¼Œè¿™é‡Œä½¿ç”¨äº†æšä¸¾çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä¹Ÿæ–¹ä¾¿è®©å¤–éƒ¨åœ¨è§„å®šä¸‹ä½¿ç”¨äº‹ä»¶ï¼Œè€Œä¸è‡³äºä¹±ä¼ ä¿¡æ¯(`EventType.MQ`ã€`EventType.Message`

```java
public abstract class LotteryService {
    private EventManager eventManager;

    public LotteryService() {
        eventManager = new EventManager(EventManager.EventType.MESSAGE,EventManager.EventType.MQ);
        eventManager.subscribe(EventManager.EventType.MQ,new MQEventListener());
        eventManager.subscribe(EventManager.EventType.MESSAGE,new MessageEventListener());
    }

    public LotteryResult draw(String uId){
        LotteryResult lotteryResult=doDraw(uId);
        // éœ€è¦è°ƒç”¨ä»€ä¹ˆç›‘å¬å°±è°ƒç”¨ä»€ä¹ˆ
        eventManager.notify(EventManager.EventType.MESSAGE,lotteryResult);
        eventManager.notify(EventManager.EventType.MQ,lotteryResult);
        return lotteryResult;
    }

    /**
     * æ‰§è¡ŒæŠ½å¥–
     * @param uId   ç”¨æˆ·Id
     * @return  æŠ½å¥–ç»“æœç±»
     */
    protected abstract LotteryResult doDraw(String uId);
}
```

- è¿™ç§ä½¿ç”¨æŠ½è±¡ç±»çš„æ–¹å¼å®šä¹‰å®ç°æ–¹æ³•ï¼Œå¯ä»¥åœ¨æ–¹æ³•ä¸­æ‰©å±•éœ€è¦çš„é¢å¤–è°ƒç”¨ã€‚å¹¶æä¾›æŠ½è±¡ç±»`abstract LotteryResult doDraw(String uId)`ï¼Œè®©ç±»çš„ç»§æ‰¿è€…å®ç°ã€‚
- åŒæ—¶æ–¹æ³•çš„å®šä¹‰ä½¿ç”¨çš„æ˜¯`protected`ï¼Œä¹Ÿå°±æ˜¯ä¿è¯å°†æ¥å¤–éƒ¨çš„è°ƒç”¨æ–¹ä¸ä¼šè°ƒç”¨åˆ°æ­¤æ–¹æ³•ï¼Œåªæœ‰è°ƒç”¨åˆ°`draw(String uId)`ï¼Œæ‰èƒ½è®©æˆ‘ä»¬å®Œæˆäº‹ä»¶é€šçŸ¥ã€‚
- æ­¤ç§æ–¹å¼çš„å®ç°å°±æ˜¯åœ¨æŠ½è±¡ç±»ä¸­å†™å¥½ä¸€ä¸ªåŸºæœ¬çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­å®Œæˆæ–°å¢é€»è¾‘çš„åŒæ—¶ï¼Œå†å¢åŠ æŠ½è±¡ç±»çš„ä½¿ç”¨ã€‚è€Œè¿™ä¸ªæŠ½è±¡ç±»çš„å®šä¹‰ä¼šæœ‰ç»§æ‰¿è€…å®ç°ã€‚
- å¦å¤–åœ¨æ„é€ å‡½æ•°ä¸­æä¾›äº†å¯¹äº‹ä»¶çš„å®šä¹‰ï¼›`eventManager.subscribe(EventManager.EventType.MQ, new MQEventListener())`ã€‚
- åœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿæ˜¯ä½¿ç”¨æšä¸¾çš„æ–¹å¼è¿›è¡Œé€šçŸ¥ä½¿ç”¨ï¼Œä¼ äº†ä»€ä¹ˆç±»å‹`EventManager.EventType.MQ`ï¼Œå°±ä¼šæ‰§è¡Œä»€ä¹ˆäº‹ä»¶é€šçŸ¥ï¼ŒæŒ‰éœ€æ·»åŠ 

ä»è°ƒç”¨ä¸Šæ¥çœ‹å‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯è¿™æ ·çš„å®ç°æ–¹å¼å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„ç»´æŠ¤ä»£ç ä»¥åŠæ‰©å±•æ–°çš„éœ€æ±‚